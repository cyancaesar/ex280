A user is an OpenShift *object* who can be granted permissions by adding *roles* to the user or user group, using *rolebindings*.

Three different types of users:

- System users: automatically created to interact with OpenShift API
- Service accounts: special system users, associated with projects to give additional privileges to Pods
- Regular users: represents people (kubeadmin and developer in CRC)

Two ways of authenticating API requests with administrator privileges:

- kubeadmin virtual user and password that grants an OAuth access token
- kubeconfig file that embeds on X.509 client certificate that does not expire

How X.509 certificate is used:

- kubeconfig file is generated during installation
	- Can be found in `~/.crc/machine/crc` or in real cluster `~/auth/kubeconfig`
- Export it as environment variable to use it `export KUBECONFIG=<kubeconfig_path>`
- `oc` command will lookup this env and can use it, `--config` to specify it manually

Authenticating with virtual user instead of X.509:

- kubeadmin virtual user is a hard-coded cluster administrator user
- Its password is shown in the log after cluster installation
- Its privileges cannot be changed, and its password is dynamically generated and hard-coded
- After setting up IdP and creating a user that has been assigned as a cluster-admin role, the hard coded can be removed (recommended)
- Deleting the hard coded user `oc delete secret kubeadmin -n kube-system` (verify first the newly created cluster admin)

Authentication method in OpenShift:

- OAuth Access Token: access token to authenticate a request
- X.509 Client Certificate: uses TLS certificate to authenticate requests

Authentication Operator (handles the requests):
- The operator runs an OAuth server
- The server provides access tokens to users that authenticate to the API
- The server works with an IdP to validate the identity of the requester
- The server connects the user with the identity and creates the OAuth access token which is next granted to the user

OpenShift Identity Providers (setup externally):

- HTPasswd: validates user and password against Kubernetes secret that is generated by htpasswd
- Keystone: uses the OpenStack Keystone server for authentication
- LDAP: LDAP IdP
- GitLab, GitHub
- OIDC: integration with OpenID Connect

In order to use HTPasswd IdP, OAuth Custom Resource must be configure.

Updating the OAuth custom resource:
- `oc get oauth cluster -o yaml > oauth.yaml`
- `oc replace -f oauth.yaml`

The procedure of creating a user, after the OAuth IdP has been configured:

- Use `htpasswd` to update the content of the htpasswd file
- Create a secret with the content of the exported file
- Set the OAuth provider to use the secret content

For adding a new user, the content of the secret must be extracted to a htpasswd file, then the `htpasswd` command is used to update that file and then a new secret is generated.

```sh
htpasswd -c -B -b htpasswd admin password
htpasswd -b htpasswd user password
oc create secret generic htpasswd-secret --from-file htpasswd=htpasswd -n openshift-config

# The newly created secret, or use describe
oc get secret -n openshift-config htpasswd-secret -o yaml

# Default one?
oc get secret -n openshift-config htpass-secret -o yaml

# Setting `admin` user as cluster admin
oc adm policy add-cluster-role-to-user cluster-admin admin

# See the current OAuth resource
oc get oauth -o yaml > oauth.yaml

# Inside, change the spec.identityProviders.htpasswd.fileData.name

# Replace the cluster resource
oc replace -f oauth.yaml

# Double check the authentication pods
oc get pods -n openshift-authentication

# View the users. the cached.
oc get users # oc get identity

# Login as the newly created user
oc login -u admin -p admin
```

Managing users:

- Extract the secret to a file: `oc extract -n openshift-config secret/htpasswd-secret`
- Update using `htpasswd`
- Write the updated secret: `oc set data secret`
- The OAuth operator redeploy the pods

```sh
oc extract secret/htpasswd-secret -n openshift-config
htpasswd -B -b htpasswd user user
oc set data secret/htpasswd-secret -n openshift-config --from-file htpasswd
```

Deleting users:

- Extract the secret to a file
- Delete user with `htpasswd -D`
- Set the secret again

Groups are a way to assign additional privileges to users:
- `oc adm groups`
- `oc adm groups new devs`
- `oc adm groups add-users devs user`
- `oc get groups`

Using `oc policy` to grant privileges to the groups. `oc policy add-role-to-group edit devs`

Assigning administrative privileges, the user must be added to the cluster-admin role: `oc adm policy add-cluster-role-to-user cluster-admin admin`